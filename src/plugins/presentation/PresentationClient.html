<html>
<head>
</htad>
<body onload="onLoad()">
<style>
html,body{background:#222;}
img{border:6px double #005565;}
</style>
<div id="imgDiv" align="center">
    <img id="img" src="intel.png" alt="5" />
    <br>
    <input id="test" type="button" value="test" style="display:none" />
</div>
<script>
var img;
var timer;
var opacity = 1.0;
var imgSrc = "";
var displayW;
var displayH;

function onLoad() {
    img = document.getElementById("img");
    displayW = 640;
    displayH = 480;
    resizeImg(img, displayW, displayH);
}

function receiveMessage(e) {
    imgSrc = event.data;

    if (timer)
        window.clearInterval(timer);
    timer = setInterval(function(){clearImg()},10);
}
window.addEventListener("message", receiveMessage, false);

document.getElementById("test").onclick = 
function(){
    img = document.getElementById("img");
    if (timer)
        window.clearInterval(timer);
    timer = setInterval(function(){clearImg()},10);
    resizeImg(img, displayW, displayH);
}

function clearDone(){
    opacity = 0;
    img.style.opacity = opacity;
    window.clearInterval(timer);
    timer = setInterval(function(){displayImg()},10);

    var imgTmp = document.createElement("IMG");
    imgTmp.src = imgSrc;
    var imgDiv = document.getElementById("imgDiv");
    imgDiv.removeChild(img);
    imgDiv.appendChild(imgTmp);
    img = imgTmp;

    resizeImg(img, displayW, displayH);
}

function clearImg(){
    if (opacity <= 0.001){
        clearDone();
        return;
    }
    
    opacity -= 0.05;
    img.style.opacity = opacity;
}

function displayDone(){
    window.clearInterval(timer);
    timer = 0;
    opacity = 1;
    img.style.opacity = opacity;
}

function displayImg(){
    if (opacity >= 1){
        displayDone();
        return;
    }
    
    opacity += 0.05;
    img.style.opacity = opacity;
}

function resizeImg(img, maxWidth, maxHeight){  
    var w = img.clientWidth,
    h = img.clientHeight;
    var wProportion, hProportion, proportion;
 
    if(w < maxWidth && h < maxHeight) return;
    
    wProportion = maxWidth/w;
    hProportion = maxHeight/h;
    
    wProportion > hProportion ? proportion = hProportion : proportion = wProportion;
    img.width = w*proportion;
    img.height = h*proportion;
}; 

</script>
</body>
</html>
